---
title: CDN
published: true
product: cdn
version: '1.0'
latest: true
---

## Getting Started

CDN is capable of serving any type of file – images, CSS, JavaScript, PDFs or anything else. Requests for files have the following format:

**Format**

```
https://{cdn-domain}/{path}
```

**Example**

```
https://cdn.somedomain.tech/user_profile.jpg
```

## Uploding Content

There is 2 endpoint to uploading content. If you want to upload image please use `/upload_image`. To upload another file except image you can use `/upload_file`.

### Uploading Image

The following table shows a list of all the available configuration parameters.

| Fieldname | Description | Type
|:--|:--|:--
| `image` | The FILE fieldname | binary file |

**Request:**

```http
POST /upload_image HTTP/1.1
Content-Type: multipart/form-data
Host: cdn.somedomain.tech
Connection: close
Content-Length: 65
```

**Response:**

```http
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Content-Length: 95

{
  "status": true,
  "message": "Image has been uploaded successfully.",
  "filename": "1614142600738-avatar.png",
  "url": "http://cdn.somedomain.tech/1614142600738-avatar.png"
}
```

### Uploading Asset

The following table shows a list of all the available configuration parameters.

| Fieldname | Description | Type
|:--|:--|:--
| `asset` | The FILE fieldname | binary file |

**Request:**

```http
POST /upload_file HTTP/1.1
Content-Type: multipart/form-data
Host: cdn.somedomain.tech
Connection: close
Content-Length: 65
```

**Response:**

```http
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Content-Length: 95

{
  "status": true,
  "message": "File has been uploaded successfully.",
  "filename": "1614133336523-jquery.min.js",
  "url": "http://cdn.somedomain.tech/1614133336523-jquery.min.js"
}
```

### Page to PDF Converter

The API to convert Page HTML to PDF. The output will be saved to CDN.

The following table shows a list of all the available configuration parameters.

| Parameter | Description | Type
|:--|:--|:--
| `url` | URL of Page | string |
| `format` | Page Format | string |
| `filename` | Generated Filename | string |

**Request:**

```http
POST /page_to_pdf HTTP/1.1
Content-Type: application/json
Host: cdn.somedomain.tech
Connection: close
Content-Length: 65

{
	"url" : "https://google.com",
	"format": "A4",
	"filename" : "google.com.pdf"
}
```

**Response:**

```http
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Content-Length: 95

{
  "status": true,
  "message": "Page has been exported to PDF successfully.",
  "filename": "1614134947997-google.com.pdf",
  "url": "http://cdn.somedomain.tech/1614134947997-google.com.pdf"
}
```

## Authentication

Whilst the main use case of CDN is to serve assets to the public in the open, there are a handful of internal endpoints that require authentication. For this, CDN includes a full-featured authentication layer based on the [Client Credentials flow of oAuth 2.0](http://oauthbible.com/#oauth-2-two-legged). Consumers must exchange a set of client credentials for a temporary access token, which must be appended to CDN requests via the `Authorization` header.

The client credentials are defined via the `auth.clientId` and `auth.secret` configuration properties, whilst the URL of the endpoint used for exchanging the client credentials for a bearer token is defined by the `auth.tokenUrl` parameter (defaults to `/token`).

### Obtaining an access token

To obtain an access token, send a POST request to the token endpoint with your client credentials. If they are correct, the response will contain a new access token along with the amount of time (in seconds) it will be valid for. If the client credentials are not valid, a 401 error is returned. Similarly, attempting to use an invalid or expired access token to access an authenticated endpoint will result in a 401 error.

**Request:**

```http
POST /token HTTP/1.1
Content-Type: application/json
Host: cdn.somedomain.tech
Connection: close
Content-Length: 65

{
  "clientId": "your-client-id",
  "secret": "your-secret"
}
```

**Response:**

```http
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Content-Length: 95

{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1MzA2MTkxNTgsImV4cCI6MTUzMDYyMDk1OH0.ceYHMu7VdybnTjV2NZRJDlERHwHmAaR-fpl4RPsO3G0",
  "tokenType": "Bearer",
  "expiresIn": 1800
}
```

### Using an access token

With an access token obtained, send a POST request to an authenticated endpoint (e.g. `/api/status`) using the access token as the value for the `Authorization` header:

```http
POST /api/status HTTP/1.1
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1MzA2MTkxNTgsImV4cCI6MTUzMDYyMDk1OH0.ceYHMu7VdybnTjV2NZRJDlERHwHmAaR-fpl4RPsO3G0
```

## Transforming images

CDN includes a full-featured image processing engine that allows various types of image conversion and manipulation to be made in real-time, based on a set of optional URL parameters supplied in the request.

**Format**

```
https://{cdn-domain}/{path}{?parameters}
```

**Example**

```
https://cdn.somedomain.tech/user_profile.jpg?width=600&height=400&format=png
```

The URL above loads a JPEG from `/user_profile.jpg` and specifies that the result should be 600x400 pixels in size and be converted to a PNG.

### Parameters

#### blur

The `blur` parameter adds blur to an image, using any value above zero.

- **Accepts:** any number from 1-100
- **Default:** 0
- **Alias:** `b`

**Examples**

`https://cdn.somedomain.tech/user_profile.jpg?blur=5`

|   |   |   
|:--|:--|:--
| ![Original JPG](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600) **Original image** | ![Blur 1](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600&blur=1 "Image") **Blur amount = 1** | ![Blur 5](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600&blur=5 "Image") **Blur amount = 5**
| ![Blur 10](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600&blur=10 "Image") **Blur amount = 10** | ![Blur 20](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600&blur=20 "Image") **Blur amount = 20** | ![Blur 20](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600&blur=100 "Image") **Blur amount = 100**

#### filter

The `filter` parameter allows you to specify the interpolation method to use when resizing images. When reducing the size of an image (or downsampling), some image data is simply discarded. However when increasing image dimensions, the image is expanded and gaps must be "filled in". Each interpolation filter uses a different algorithm for determining how to fill the gaps.

- **Accepts:** valid values are `lanczos`, `nearest-neighbor`, `linear`, `cubic`, `grid`, `moving-average`
- **Default:** `lanczos`
- **Alias:** `f`

**Example**

```http
https://cdn.somedomain.tech/user_profile.jpg?width=600&height=400&resize=aspectfill&filter=linear
```

The following filters are available:

| **Filter**  | **Description**  
|:--|:--
| `nearest-neighbor` | The simplest approach to interpolation. Rather than calculating an average value by some weighting criteria or generating an intermediate value based on complicated rules, this method simply determines the "nearest" neighbouring pixel, and assumes the intensity value of it.
| `linear` | Considers the closest two pixels and takes a weighted average to arrive at its final interpolated value. Results in a much smoother image than `nearest-neighbor`.
| `cubic` | Images resampled with cubic interpolation are smoother and have fewer interpolation artifacts, but processing is slower than with `linear` or `nearest-neighbor`.
| `lanczos` | Tends to reduce aliasing artifacts and preserve sharp edges. [It has been considered the "best compromise"](http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.116.7898) among several simple filters for this purpose.

#### flip

The `flip` parameter flips images horizontally, vertically or both. A horizontal flip can also be referred to as "mirroring".

- **Accepts:** valid values are `x`, `y` and `xy`
- **Default:** 0
- **Alias:** `fl`

| **Horizontal flip: ?flip=x**  | **Vertical flip: ?flip=y**  | **Horizontal and vertical flip: ?flip=xy**  
|:--|:--|:--
| ![Dog flipped on the X axis](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600&flip=x "Image") | ![Dog flipped on the Y axis](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600&flip=y "Image") | ![Dog flipped on both axes](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600&flip=xy "Image")

#### format

Use the `format` parameter to specify the required output image format.

- **Accepts:** valid values are `jpg`, `png`, `gif`, `webp`
- **Default:** output defaults to the same as the input image 
- **Alias:** `fmt`

When choosing WebP as the output format, it's possible to specify another format to be used as a fallback in case the requesting client doesn't have WebP support. The fallback is added to the `format` parameter, separated by a comma – e.g. `?format=webp,jpg`.


**Original JPG Image**

![Original JPG](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600)

**JPG to PNG**

`https://cdn.somedomain.tech/user_profile.jpg?format=png`

![PNG](http://localhost:9001/user_profile.jpg?resize=aspectfit&w=600&format=png "Image credit: Yamon Figurs (https://unsplash.com/@yamonf16)")

##### from GIF

**GIF to JPG**

`https://cdn.somedomain.tech/user_profile.png?format=jpg`

![JPG](http://localhost:9001/user_profile.gif?w=400&resize=aspectfit&format=jpg)

**GIF to PNG**

`https://cdn.somedomain.tech/user_profile.gif?format=png`

![PNG](http://localhost:9001/user_profile.gif?w=400&resize=aspectfit&format=png)

##### from PNG

**Original PNG Image**

![Original PNG](http://localhost:9001/user_profile.png?w=400&resize=aspectfit)

**PNG to JPG**

`https://cdn.somedomain.tech/user_profile_2.png?w=400&resize=aspectfit&format=jpg`

![JPG](http://localhost:9001/user_profile_2.png?w=400&resize=aspectfit&format=jpg)

#### progressive

Add `progressive=true` to the image parameters to have CDN serve a progressice JPEG.

#### gravity

Used to position the crop area. Available options (case sensitive):

- `northwest`
- `north`
- `northeast`
- `west`
- `center`
- `east`
- `southWest`
- `south`
- `southeast`
- `none`

**Original image**

`https://cdn.somedomain.tech/user_profile.jpg`

| g=west | g=center | g=east
|:--|:--|:--
| ![](http://localhost:9001/user_profile_2.jpg?w=400&h=300&resize=aspectfill&g=west "Image") | ![](http://localhost:9001/user_profile_2.jpg?w=400&h=300&resize=aspectfill&g=center "Image") | ![](http://localhost:9001/user_profile_2.jpg?w=400&h=300&resize=aspectfill&g=east "Image")

#### height

The `height` parameter is used to specify the required height of the output image, in pixels.

- **Default:** original height dimension
- **Alias:** `h`

If only height is specified, the width dimension will be _set to the width of the original image_. If you'd like to ensure the output image retains the aspect ratio of the original image, please ensure `resize=aspectfit` is specified.

If both width and height are omitted, the original image’s dimensions are used.

> **Security Note:**
> 
> The maximum output image size can be specified in the configuration file.
> 
> The `security` setting allows you to set a maximum width and height for generated images. This prevents the potential for a DOS attack based on the repeated generation of large images which could push your platform offline by exhausting CPU and/or available memory.
>
> You should set this to the maximum size required for images in your application.
>
> ```json
> "security": {
>  "maxWidth": 2048,
>  "maxHeight": 1024
>}
>```
> -- advice

**Example**

`https://cdn.somedomain.tech/user_profile_2.jpg?h=400&resize=aspectfit`

| **h=400** | **h=400&resize=aspectfit** 
|:--|:--
| ![Height 400](http://localhost:9001/user_profile_2.jpg?h=400 "Image") | ![Height 400, Aspect Fit](http://localhost:9001/user_profile_2.jpg?h=400&resize=aspectfit "Image")

#### quality

The `quality` parameter applies compression to an image, reducing it's file size.

- **Accepts:** any number from 1-100
- **Default:** 75
- **Alias:** `q`

The best results for quality and file size can be found around 40-60, where we've found generated images to be visually indistinguishable from the source image.

**Examples**

The original image and all quality variations below are 2048 × 1024 pixels.

**Original image, 4.7MB**

`https://cdn.somedomain.tech/user_profile_2.jpg`

|   |   
|:--|:--
| ![Quality 100](http://localhost:9001/user_profile_2.jpg?q=100&w=300&resize=aspectfit "Image") **Quality = 100, 1.3MB** | ![Quality 75](http://localhost:9001/user_profile_2.jpg?q=75&w=300&resize=aspectfit "Image") **Quality = 75, 180kB**
| ![Quality 50](http://localhost:9001/user_profile_2.jpg?q=50&w=300&resize=aspectfit "Image") **Quality = 50, 119kB** | ![Quality 25](http://localhost:9001/user_profile_2.jpg?q=25&w=300&resize=aspectfit "Image") **Quality = 25, 82kB**

#### ratio

Use the `ratio` parameter in combination with width (`w`) or height (`h`) to crop the image to the specified aspect ratio. [Resize styles](/#cdn/specifying-a-resizestyle) are respected.

```
https://cdn.somedomain.tech/user_profile.jpg?h=400&ratio=16-9
```

#### rotate

The `rotate` parameter rotates the image according to the value specified in degrees. The image will be zoomed so that it covers the entire area after rotation.

- **Accepts:** any number from 0-359
- **Default:** 0

#### saturate

The `saturate` parameter increases or reduces an image's colour saturation and can be used to convert it to black and white.

- **Accepts:** 0 or 1
- **Default:** none
- **Alias:** `sat`


To desaturate (convert to black and white), use `0` or any number below 0.

```http
https://cdn.somedomain.tech/user_profile.jpg?saturate=0
```
| **Saturate amount = 0 (B&W)**  |   **Saturate amount = 1**
|:--|:--
| ![Saturate 0](http://localhost:9001/user_profile.jpg?w=400&resize=aspectfit&sat=0 "Image") | ![Saturate 1](http://localhost:9001/user_profile.jpg?w=400&resize=aspectfit&sat=1 "Image")

#### sharpen

The `sharpen` parameter adds sharpness to an image.

- **Accepts:** 0-5
- **Default:** 0
- **Alias:** `sh`

**Example**

```http
https://cdn.somedomain.tech/user_profile.jpg?sharpen=1
```
| **Default amount = 0** | **Sharpen amount = 1** | **Sharpen amount = 5**
|:--|:--|:--
| ![Sharpen 0](http://localhost:9001/user_profile.jpg?w=400&resize=aspectfit&sharpen=0 "Image") | ![Sharpen 1](http://localhost:9001/user_profile.jpg?w=400&resize=aspectfit&sharpen=1 "Image") | ![Sharpen 5](http://localhost:9001/user_profile.jpg?w=400&resize=aspectfit&sharpen=5 "Image")

#### width

The `width` parameter is used to specify the required width of the output image, in pixels.

- **Default:** original width dimension
- **Alias:** `w`

If only width is specified, the height dimension will be _set to the height of the original image_. If you'd like to ensure the output image retains the aspect ratio of the original image, please ensure `resize=aspectfit` is specified.

If both width and height are omitted, the original image’s dimensions are used.

> **Security Note:**
> 
> The maximum output image size can be specified in the configuration file.
> 
> The `security` setting allows you to set a maximum width and height for generated images. This prevents the potential for a DOS attack based on the repeated generation of large images which could push your platform offline by exhausting CPU and/or available memory.
>
> You should set this to the maximum size required for images in your application.
>
> ```json
> "security": {
>  "maxWidth": 2048,
>  "maxHeight": 1024
>}
>```
> -- advice

**Example**

`https://cdn.somedomain.tech/user_profile.jpg?w=400&resize=aspectfit`

| **w=400** | **w=400&resize=aspectfit** 
|:--|:--
| ![Width 400](http://localhost:9001/user_profile_2.jpg?w=400 "Image") | ![Width 400, Aspect Fit](http://localhost:9001/user_profile_2.jpg?w=400&resize=aspectfit "Image")

### Resizing

Images can be easily resized using Image Manipulation CDN. Use the `resize` parameter with `width` and `height` to resize images, or specify `crop` along with crop coordinates for full control over the portion of the original image that is retained.

There are several ways to resize an image, the simplest of which is to specify the dimensions of the output images. Use `width` and `height` parameters to specify the final dimensions of the output image.

#### Using the width parameter

The `width` parameter (alias: `w`) specifies the width of the required output image in pixels. If only `width` is specified, the height dimension will be calculated automatically so that the original aspect ratio of the image is maintained given the new width. If both `width` and `height` are omitted, the original image’s dimensions are used.

> **Security Note:**
> 
> The maximum output image size can be specified in the configuration file.
> 
> The `security` setting allows you to set a maximum width and height for generated images. This prevents the potential for a DOS attack based on the repeated generation of large images which could push your platform offline by exhausting CPU and/or available memory.
>
> You should set this to the maximum size required for images in your application.
>
> ```json
> "security": {
>  "maxWidth": 2048,
>  "maxHeight": 1024
>}
>```
>
> -- advice

**Example**

`https://cdn.somedomain.tech/user_profile_2.jpg?w=400`
 
#### Using the height parameter

The `height` parameter (alias: `h`) specifies the height of the required output image in pixels. If only `height` is specified, the width dimension will be calculated automatically so that the original aspect ratio of the image is maintained given the new height. If both width and height are omitted, the original image’s dimensions are used.

> **Security Note:**
> 
> The maximum output image size can be specified in the configuration file.
> 
> The `security` setting allows you to set a maximum width and height for generated images. This prevents the potential for a DOS attack based on the repeated generation of large images which could push your platform offline by exhausting CPU and/or available memory.
>
> You should set this to the maximum size required for images in your application.
>
> ```json
> "security": {
>  "maxWidth": 2048,
>  "maxHeight": 1024
>}
>```
>
> -- advice

**Example**

`https://cdn.somedomain.tech/user_profile_2.jpg?h=400`

#### Specifying aspect ratio

Images can be resized to a specified aspect ratio by providing a `width` or `height` in combination with the `ratio` parameter. CDN will respect any [resizeStyle](#specifying-a-resizestyle) specified.

```
https://cdn.somedomain.tech/user_profile_2.jpg?h=400&ratio=16-9
```

![Height of 400, aspect ratio of 16-9](http://localhost:9001/user_profile_2.jpg?h=400&ratio=16-9 "Image") 

#### Specifying a resize style

The `resizeStyle` (alias: `resize`) parameter allows you to specify how CDN should fit your image into the specified dimensions.

##### aspectfill

Keeps the aspect ratio of the original image and generates an output image of the specified width and height. The output image may be cropped, however by specifying the `gravity` parameter you can tell CDN which part of the image should be retained.

> The output image is 400 x 300 pixels.

![Width of 400, height of 300, resize style of aspectfill](http://localhost:9001/user_profile_2.jpg?w=400&h=300&resize=aspectfill "Image")

##### aspectfit

Keeps the aspect ratio of the original image and generates an output image with the maximum dimensions that fit inside the specified width and height.

> The output image is 400 x 267 pixels.

![Width of 400, height of 300, resize style of aspectfit](http://localhost:9001/user_profile_2.jpg?w=400&h=300&resize=aspectfit "Image")

##### crop

When `crop` is used as the resize style then an additional parameter must be used to specify the coordinates of the crop rectangle. There are two ways to pass the crop rectangle coordinates:

- Specify only the top left corner of the rectangle

  `?resizeStyle=crop&crop=10,15`

- Specify the top left and the bottom right corners of the rectangle

  `?resizeStyle=crop&crop=10,15,200,300`

##### entropy

Used in combination with width and height parameters, `entropy` crops the image using a technique that determines the most important areas. Areas of higher contrast are considered more important, and images are often cropped to remove large areas of static colour.

`https://cdn.somedomain.tech/user_profile_2.jpg?w=250&h=300&resize=entropy`

| **Original image** | **Entropy crop**
|:--|:--
| ![](http://localhost:9001/user_profile_2.jpg?w=400&h=300 "Image") | ![](http://localhost:9001/user_profile_2.jpg?w=250&h=300&resize=entropy "Image")

##### fill

Generates an output image with the exact specified width and height dimensions, ignoring the aspect ratio of the original image. The output image may appear squashed or stretched.

> The output image is 400 x 300 pixels.

![Width of 400, height of 300, resize style of fill](http://localhost:9001/user_profile_2.jpg?w=400&h=300&resize=fill "Image")

##### gravity

Used to position the crop area. See [Parameters / gravity](#gravity) for details and examples.

### Cropping

For more control over the output image than available when using the standard resize style options `aspectFit`, `aspectFill`, `fit` and `fill`, you can specify three different ways to crop an image.

#### Top-left crop

By specifying only the top left corner of the crop rectangle, CDN works out the full crop rectangle size by using the specified `width` and `height` parameters. To obtain an image that is 300 wide and 400 high, but cropped from 100 pixels from the top edge:

`https://cdn.somedomain.tech/user_profile_2.jpg?resize=crop&crop=0,10&width=300&height=400`

![](http://localhost:9001/user_profile_2.jpg?resize=crop&crop=0,10&width=300&height=400 "Image")

#### Crop rectangle

It is also possible to supply both the top left and the bottom right coordinates of a crop rectangle (e.g. `resize=crop&crop=0,0,100,100`). This allows you to selectively crop an exact area out of an image.

Let's take a look at some examples. We'll use our `400x400` pixel image, which has squares marked at `x, y (size)`: `0,0 (25 px)`, `25,25 (25px)`, `50,50 (50px)`, `100,100 (100px)`, `200,200 (200px)`: 

![](http://localhost:9001/user_profile_2.png)

We can crop the second and third boxes by supplying a top left of `50,50`, and a bottom right of `200,200`, giving us a `150x150` pixel image:

`https://cdn.somedomain.tech/user_profile_2.png?resize=crop&crop=50,50,200,200`

![](http://localhost:9001/user_profile_2.png?resize=crop&crop=50,50,200,200)

We're also able to change the size of the image we get back. Let's change it to `100` pixels wide. In this case, the height will be inferred from the width. The same goes if we only supply a height.

`https://cdn.somedomain.tech/user_profile_2.png?resize=crop&crop=50,50,200,200&width=100`

![](http://localhost:9001/user_profile_2.png?resize=crop&crop=50,50,200,200&width=100)

If you really want to get creative, you can supply a cropping rectangle along with both a width and height, which will allow you to completely resize an image after cropping. Let's take the above image and squash it.

`https://cdn.somedomain.tech/user_profile_2.png?resize=crop&crop=50,50,200,200&width=400&height=100`

![](http://localhost:9001/user_profile_2.png?resize=crop&crop=50,50,200,200&width=400&height=100)

Another way of resizing our crops, if we don't want to be as specific, is to provide the `devicePixelRatio` ratio.

`https://cdn.somedomain.tech/user_profile_2.png?resize=crop&crop=50,50,200,200&devicePixelRatio=2`

![](http://localhost:9001/user_profile_2.png?resize=crop&crop=50,50,200,200&&devicePixelRatio=2)

Read more about [dealing with pixel ratios](#dealing-with-pixel-ratios).

#### Entropy

Using `resize=entropy` crops the image using a technique that determines the most important areas.

Read more about [entropy](#entropy).

### Example use case

For this example, we're going to imagine you have a magazine-style website with a list of articles on the homepage and an article page. We'll start with the following image, which your editor wants to use as the main article image.

**Original image, 5616 × 3744 px, 4MB**

`https://cdn.somedomain.tech/user_profile.jpg`

This is a large image, and it's not going to fit easily into the two spaces we have available for it. Unfortunately, no one in the department knows how to use Adobe Photoshop to make appropriately sized images. Fortunately, CDN can handle this task for you.

#### Resizing and cropping

On the article page, let’s assume your main image spot is a 500×300 pixel container. It's an odd size, but illustrates this concept well. To fit the base image into that container, we’ll need to change the dimensions and crop some data from the top and bottom.

To adjust the image we need to specify the new width and height, as well as tell CDN how we want to crop the image.

`https://cdn.somedomain.tech/user_profile_2.jpg?w=500&h=300&resize=entropy`

* `width=500&height=300`: Sets the width and height to fit the container.

* `resize=entropy`: Tells CDN how to determine the crop area. [Entropy](#entropy) is a smart cropping feature that adjusts the crop area to ensure the important part of your image is retained. It uses areas of high contrast to set the crop area.

**Resized image, 500 × 300 px, 98kB**

![Resized image, 500 × 300 px, 98kB](http://localhost:9001/user_profile_2.jpg?w=500&h=300&resize=entropy "Image")

Now, on the homepage, let’s assume each feature article has an image container that is 200×200 pixels. With the main subject of the image so close to the right, we'll once again need to tell CDN how we want the image cropped.

`https://cdn.somedomain.tech/user_profile_2.jpg?w=200&h=200&resize=entropy`

**Resized image, 200 × 200 px, 29kB**

![Resized image, 200 × 200 px, 29kB](http://localhost:9001/user_profile_2.jpg?w=200&h=200&resize=entropy "Image")

If we don't specify `entropy` as the `resize` parameter, CDN defaults to using `aspectfit` and our image would look a little different, with the main subject almost excluded from the image.

`https://cdn.somedomain.tech/user_profile_2.jpg?w=200&h=200`

![Aspectfit, 200 × 200 px, 29kB](http://localhost:9001/user_profile_2.jpg?w=200&h=200 "Image")

## Transforming CSS

CDN is capable of processing CSS in real-time based on a set of optional URL parameters supplied in the request.

**Format**

```
https://{cdn-domain}/{path}{?parameters}
```

**Example**

```
https://cdn.somedomain.tech/styles.css?compress=1
```

### Parameters

#### compress

Returns a compressed version of a style sheet by removing all unnecessary or redundant data without affecting how the resource is processed by the browser. It removes code comments, spaces and line breaks.

**Example (input)**

```css
/* This comment will go away */
p {
  color: blue;
  width: 1.2em;
}

/* This one will go too */
h1 {
  font-weight: bold;
  line-height: 1.3;
}
```

**Example (output)**

```css
p{color:#00f;width:1.2em}h1{font-weight:700;line-height:1.3}
```

## Transforming JavaScript

CDN is capable of processing JavaScript in real-time based on a set of optional URL parameters supplied in the request.

**Format**

```
https://{cdn-domain}/{path}{?parameters}
```

**Example**

```
https://cdn.somedomain.tech/script.js?compress=1&transform=1
```

### Parameters

#### compress

Returns a compressed (minified) version of the JavaScript file by removing all unnecessary or redundant data without affecting how the resource is processed by the browser.

**Example (input)**

```js
let numbers = [1,2,3]

numbers.forEach(number => {
  console.log(`Hi, I'm number ${number}`)
})
```

**Example (output)**

```js
let numbers=[1,2,3];numbers.forEach(a=>{console.log(`Hi, I'm number ${a}`)});
```

#### transform

> **Experimental**
> 
> This feature is experimental and it should be considered unstable. To enable it, you must set the `experimental.jsTranspiling` configuration property or the `JSTRANSPILING` environment variable to `true`.
>
> -- warning

Analyses the ECMAScript features used in the JavaScript file and makes any necessary translations (i.e. transpiling) so that the script is fully compatible with the requesting browser, using the `User-Agent` header to determine the capabilities of the client.

It's a common practice to transpile JavaScript bundles at build time, creating an ES5-compatible script that will be delivered to all clients – even to the ones that fully support the original, modern and often times faster ES6 features. CDN offers an alternative approach to this, whereby transpiling scripts *on the edge* means that only the features that are not supported by the client will be modified, leaving the rest of the code untouched.

**Example (input)**

```js
let numbers = [1,2,3]

numbers.forEach(number => {
  console.log(`Hi, I'm number ${number}`)
})
```

**Example (output on IE8)**

```js
"use strict";

var numbers = [1, 2, 3];

numbers.forEach(function (number) {
  console.log("Hi, I'm number " + number);
});
```

**Example (output on Chrome 66)**

```js
let numbers = [1,2,3]

numbers.forEach(number => {
  console.log(`Hi, I'm number ${number}`)
})
```

## Delivery recipes

A Delivery Recipe is a predefined set of image manipulation parameters stored in a JSON file and applied to images at the time of request.

Let's use the image from our magazine example:

`https://cdn.somedomain.tech/thumbnail/samples/beach.jpeg`

`https://cdn.somedomain.tech/samples/beach.jpeg?width=100&height=100&resizeStyle=entropy`

![Thumbnail image, 100 × 100 px, 9kB](https://cdn.somedomain.tech/samples/beach.jpeg?width=100&height=100&resizeStyle=entropy "Image credit: Danielle MacInnes (https://unsplash.com/@dsmacinnes)")

Recipes are defined in JSON files held in the `/workspace/recipes` folder.

### Example recipe

```json
{
  "recipe": "thumbnail",
  "settings": {
    "format": "jpg",
    "quality": "80",
    "width": "100",
    "height": "100",
    "resizeStyle": "entropy"
  }
}
```

### Using a recipe

Making use of a recipe is simple: call your image via the recipe name defined in the recipe JSON.

For example:

`https://cdn.somedomain.tech/thumbnail/image-filename.png`

## Delivery routes

Delivery Routes allow you to let CDN choose the appropriate recipe based on device, network, location or language.

Routes allow CDN to make a decision about which [Delivery Recipe](#delivery-recipes) to use for the current request, based on a set of configurable conditions.

Conditions can include the type of device being used, the network type, user location and language.

### Creating a route

A route is defined in JSON format and added to a directory in your CDN installation. The default location for route files is `workspace/routes`, but this is configurable.

You can create route files in a text editor and manually copy them to the routes folder, or you can send a `POST` request to CDN with the route content and have CDN create it for you.

### POSTing to CDN

Send a `POST` request to the routes endpoint with the request body containing the route content.

**An example using cURL**

```
curl -i -H "Content-Type: application/json" -X POST "https://cdn.somedomain.tech/api/routes" -d '{
  "route": "example-route",
  "branches": [
    {
      "recipe": "thumbnail"
    }
  ]
}'
```
**Response Codes**

Status Code | Description | Response
----|------|--------
200 | Route saved successfully | `{ success: true }`
400 | No request body sent | `{ success: false,  errors: ['Bad Request'] } `
400 | Route validation failed | `{ success: false, errors: validationErrors }`
400 | A route with the same name already exists | `{ success: false, errors: ['Route already exists'] }`
400 | An error occurred when saving | `{ success: false, errors: ['Error when saving route'] }`

### Route basics

A route must contain a `name` property, as well as an array of `branches` which contain the conditions that must be true for CDN to select the route.

At a minimum, a route must take the following form. The `branches` array below contains a single branch with no conditions, representing the default recipe to use.

```json
{
  "route": "example-route",
  "branches": [
    {
      "recipe": "thumbnail"
    }
  ]
}
```

### Branches

Each branch within the `branches` array should contain two properties, `recipe` and `condition`.

* `recipe` (string) - the name of the [Delivery Recipe](#delivery-recipes) to use when all specified conditions are met

* `condition` (object) - contains properties that correspond to test types

```json
{
  "route": "example-route",
  "branches": [
    {
      "recipe": "thumbnail-120",
      "condition": {
        "device": "desktop"
      }
    },
    {
      "recipe": "thumbnail-50"
    }
  ]
}
```

### Branch evaluation

Branches are evaluated in the order they appear in the route. If a branch condition is not met, the branch is skipped and the next one evaluated.

The default case (where none of the conditions are met) is handled by a branch with a `recipe` but no `condition`, which is matched immediately. This branch must be last in the array, otherwise it may be used when you don't intend it to be.

### Conditions

#### Device

The `device` condition matches the user's device type, based on the user-agent header sent in the request.

Possible values:

- `console`
- `desktop`
- `embedded`
- `mobile`
- `smarttv`
- `tablet`
- `wearable`

The `device` condition can test against a single device type:

```json
"condition": {
  "device": "mobile"
}
```

...or multiple device types:

```json
"condition": {
  "device": ["tablet", "smarttv"]
}
```

##### Default value

If a device type is specified that doesn't match one of the possible values above, CDN uses `desktop` in its place.

#### Location

The `location` condition uses the IP address from the request and performs a GeoLocation lookup to obtain the user's approximate location.

CDN can perform the GeoLocation lookup using the [Maxmind GeoIP](http://dev.maxmind.com/geoip/) database (bundled with the application), or by making a request to any remote address (such as the GeoLocation API).

##### Configuring CDN to use the Maxmind GeoIP database

To use the Maxmind GeoIP database CDN's main configuration file should contain the following block:

```json
"geolocation": {
  "enabled": true,
  "method": "maxmind",
  "countryDbPath": "vendor/maxmind-country.mmdb"
}
```

If no value is provided for `countryDbPath` it defaults to the one shown in the above example.

##### Configuring CDN for remote lookup

To use a remote lookup service, the `geolocation` block in CDN's main configuration file should specify a remote URI.

The URI format uses placeholders (shown below with curly braces) to indicate where CDN should insert the parameters required for the lookup.

**Placeholders**

* `{ip}` - the IP address to lookup
* `{key}` - *(optional)* an API key required to access the remote service
* `{secret}` - *(optional)* a secret key required to access the remote service

`{key}` and `{secret}` can be set either in the configuration file or as environment variables. Set the environment variables `GEOLOCATION_REMOTE_KEY` and `GEOLOCATION_REMOTE_SECRET` to enable CDN to read these values from the environment.

```json
"geolocation": {
  "enabled": true,
  "method": "remote",
  "url": "https://api.example.com/location/?key={key}&secret={secret}&ip={ip}",
  "key": "1234567",
  "secret": "1q2w3e4r"
}
```

**Response format**

By default CDN expects a response from the remote service in the format used by the GeoLocation service, where the path for the country code within the response is `location.country.isoCode`.

If the response format for the service you use differs (and it probably does), you can tell CDN where to find the country code in the response by adding a `path` property to the `geolocation` configuration block.

```json
"geolocation": {
  "enabled": true,
  "method": "remote",
  "url": "https://api.other-service.com/location/?key={key}&secret={secret}&ip={ip}",
  "key": "1234567",
  "secret": "1q2w3e4r",
  "path": "results.address.country"
}
```

#### Language

The `language` condition is based on the `Accept-Language` headers sent in the request. Values are ISO 639-1 language codes.

The following condition will be met if the request contains the header `Accept-Language: en`

```json
"condition": {
  "language": "en"
}
```

Language detection has support for [quality values](https://tools.ietf.org/html/rfc2616#section-14.4), which represent an estimate of the user's preference for multiple languages. By default only the main language (`quality = 1`) is used, but this can be changed by adding an optional `languageMinQuality` property to the condition, which adjusts the threshold.


```json
"condition": {
  "language": ["en", "pt"],
  "languageMinQuality": 0.5
}
```

#### Network

Specifying the `network` condition in a route performs a remote lookup on a network connectivity API to determine the type of connection being used.

> **Note:** This condition tests for a connection *type* (e.g. `cable` or `mobile`) and not connection *speed*.

The condition can be specified as a single connection type:

```json
"condition": {
  "network": "cable"
}
```

...or as an array of multiple connection types:

```json
"condition": {
  "network": ["cable", "dsl"]
}
```

##### Configuration

The configuration block required for network connectivity lookups is similar to that used for GeoLocation.

```json
"network": {
  "url": "https://api.example.com/connectivity/?key={key}&secret={secret}&ip={ip}",
  "key": "1234567",
  "secret": "1q2w3e4r"
}
```

The URI format uses placeholders (shown below with curly braces) to indicate where CDN should insert the parameters required for the lookup.

**Placeholders**

* `{ip}` - the IP address to lookup
* `{key}` - *(optional)* an API key required to access the remote service
* `{secret}` - *(optional)* a secret key required to access the remote service

`{key}` and `{secret}` can be set either in the configuration file or as environment variables. Set the environment variables `NETWORK_REMOTE_KEY` and `NETWORK_REMOTE_SECRET` to enable CDN to read these values from the environment.

**Response format**

By default CDN expects a response from the remote service in the format used by the Network Connectivity service, where the path for the connection type within the response is `speed.connectionType`.

If the response format for the service you use differs (and it probably does), you can tell CDN where to find the connection type in the response by adding a `path` property to the `network` configuration block.

```json
"network": {
  "url": "https://api.other-service.com/connectivity/?key={key}&secret={secret}&ip={ip}",
  "key": "1234567",
  "secret": "1q2w3e4r",
  "path": "results.connection.type"
}
```

### Caching

Caching is automatically enabled for routes. Depending on what's defined in the config, it uses Redis or the local filesystem.

**Example route**

```json
{
  "route": "sample-route",
  "branches": [
    {
      "recipe": "thumbnail",
      "condition": {
        "device": "desktop",
        "language": "en",
        "country": ["GB", "US"],
        "network": "cable"
      }
    },
    {
      "recipe": "thumbnail-lo-res",
      "condition": {
        "device": ["mobile", "tablet"],
        "language": ["en", "pt"],
        "country": "GB",
        "network": ["cable", "dsl"]
      }
    },
    {
      "recipe": "default-recipe"
    }
  ]
}
```

## Retrieving a colour palette

Each image stored in _CDN_ can be returned as a json object with information on how the image was generated. Within that object there are `primaryColor` and `palette` nodes which contains information about the colour of the image.

Request URL:

```
https://cdn.somedomain.tech/user_profile.png?format=json
```

Response JSON:

```json
{
  "fileName": "user_profile.png",
  "cacheReference": "7f41286536d5e0eef2c92a624d07e75d799429b2",
  "quality": 75,
  "trim": 0,
  "trimFuzz": 0,
  "resizeStyle": "aspectfit",
  "gravity": "None",
  "filter": "lanczos",
  "blur": 0,
  "strip": 0,
  "rotate": 0,
  "flip": 0,
  "ratio": 0,
  "devicePixelRatio": 0,
  "format": "png",
  "fileSizePre": 622980,
  "primaryColorPre": "#b7c4d2",
  "palettePre": {
    "rgb": [
      [
        27,
        20,
        12
      ],
      [
        99,
        76,
        65
      ],
      [
        151,
        166,
        185
      ],
      [
        193,
        205,
        239
      ],
      [
        38,
        110,
        128
      ]
    ],
    "hex": [
      "#1b140c",
      "#634c41",
      "#97a6b9",
      "#c1cdef",
      "#266e80"
    ]
  },
  "fileSizePost": 992176,
  "primaryColorPost": "#b7c4d2",
  "palettePost": {
    "rgb": [
      [
        27,
        20,
        12
      ],
      [
        99,
        76,
        65
      ],
      [
        151,
        166,
        185
      ],
      [
        193,
        205,
        239
      ],
      [
        38,
        110,
        128
      ]
    ],
    "hex": [
      "#1b140c",
      "#634c41",
      "#97a6b9",
      "#c1cdef",
      "#266e80"
    ]
  }
}
 ```

| Input image | Generated palette
|:--|:--
|![input image](http://localhost:9001/user_profile.png?w=400&resize=aspectfit)|<img src="/assets/cdn/palette-output.png" alt="generated palette" width="400">|

## Dealing with pixel ratios

When dealing with multiple device pixel ratios, you can 'multiply' the outputted size of the image by adding the parameter `devicePixelRatio` to your query. `devicePixelRatio` can be anywhere from 1 to 3. Supplying this parameter will inform the CDN to multiply the output dimensions by that factor.

For example a `100px x 100px` image with the variable `devicePixelRatio=2` will return an image of `200px x 200px` in size. You can then scale down the image in your front-end output e.g.,

```html
<img src="https://cdn.somedomain.tech/user_profile_2.jpg?w=100&height=100&devicePixelRatio=2" width="100">
```

But why not just use `width=200&height=200`, right? Well `devicePixelRatio` becomes more powerful when cropping, for example. You could crop an image to take out a `150px x 150px` chunk:

```html
<img src="https://cdn.somedomain.tech/user_profile_2.png?resize=crop&crop=50,50,200,200" width="300">
```

![150x150](http://localhost:9001/user_profile_2.png?resize=crop&crop=50,50,200,200)

and then enlarge it to `300px x 300px`:

```html
<img src="https://cdn.somedomain.tech/user_profile_2.png?resize=crop&crop=50,50,200,200&devicePixelRatio=2" width="300">
```

![300x300](http://localhost:9001/user_profile_2.png?resize=crop&crop=50,50,200,200&devicePixelRatio=2)

It is also possible to set the width, height, or both width & height explicitly, if we wanted an image of 600x600 for a HDPI display, etc:

```html
<img src="https://cdn.somedomain.tech/user_profile_2.png?resize=crop&crop=50,50,200,200&width=600" width="300">
```

![600x600](http://localhost:9001/user_profile_2.png?resize=crop&crop=50,50,200,200&width=600)

Read more about [Cropping Images](#cropping-images).



## Server status

A "status" endpoint can be enabled at `/api/status` for performance monitoring. Add a `status` configuration section to the main configuration file using the settings below.

| Path | Description | Environment variable | Default | Format
|:--|:--|:--|:--|:--
| `status.enabled` | If true, status endpoint is enabled. | *N/A* | `true` | Boolean
| `status.requireAuthentication` | If true, status endpoint requires authentication. | *N/A* | `true` | Boolean
| `status.standalone` | If true, status endpoint will run on an standalone address/port. | *N/A* |  | Boolean
| `status.port` | Accept connections on the specified port. A value of zero will assign a random port. | `STATUS_PORT` | `8003` | Number
| `status.routes` | An array of routes to test. Each route object must contain properties `route` and `expectedResponseTime`. Note, `expectedResponseTime` is seconds. | *N/A* | `[{"route":"/test.jpg?format=png&quality=50&width=800&height=600","expectedResponseTime":0.025}]` | Array

To use the status endpoint [an access token](#authentication) must first be obtained. With an access token obtained, send a POST request to `/api/status` using the access token as the value for the `Authorization` header:

```http
POST /api/status HTTP/1.1
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1MzA2MTkxNTgsImV4cCI6MTUzMDYyMDk1OH0.ceYHMu7VdybnTjV2NZRJDlERHwHmAaR-fpl4RPsO3G0
```